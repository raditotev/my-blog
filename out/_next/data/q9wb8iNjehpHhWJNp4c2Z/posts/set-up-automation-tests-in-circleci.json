{"pageProps":{"post":{"id":"set-up-automation-tests-in-circleci","title":"Set up automation tests in CircleCI","date":"2018-12-09T00:00:00.000Z","description":"Description of the work done integrating e2e test in the CircleCI CI/CD. Article contains also yaml file for each of the jobs discussed.","markdown":"\nRecently the company I work for moved the CI/CD from Shippable to CircleCI. This is a quick guide on how to create a job and workflow.I have created two different workflows for my needs . One called **nightly** running all tests from the feature tests repo every day from Monday to Friday at 4am and one used externally from the application under test workflow called **feature-tests**.\n\n## Nightly\n\nFirst create the job. I have called mine tests. Then I specified the base docker image I want to use for the job, i.e. `circleci/ruby:2.5-browsers-legacy`. I won't go in too much detail for all the steps because they will be generated automatically for you once you add you automation tests in CircleCI (for more information see [here](https://circleci.com/docs/2.0/project-build/#section=getting-started)). The most important thing to know about the job is that you'll have to use bundle install cucumber instead of just cucumber because all gems will be installed in a custom location `bundle install --jobs=4 --retry=3 --path vendor/bundle`. The other tip is to specify the path where the test reports can be found after completion - `store_test_results: path: /tmp`. Make sure the path set is the same as the one you have in `cucumber.yml`. Also make sure the output format is junit so you can see the number of passing and failing tests at first glance in the tab **Results** after the job is finished.\n\n```yml\n# /.circleci/config.yml\n# Ruby CircleCI 2.0 configuration file\n#\n# Check https://circleci.com/docs/2.0/language-ruby/ for more details\n#\njobs:\n  test:\n    docker:\n      - image: circleci/ruby:2.5-browsers-legacy\n    working_directory: ~/repo\n    steps:\n      - checkout\n      # Download and cache dependencies\n      - restore_cache:\n          keys:\n            - v1-dependencies-{{ checksum \"Gemfile.lock\" }}\n            # fallback to using the latest cache if no exact match is found\n            - v1-dependencies-\n\n      - run:\n          name: install dependencies\n          command: |\n            bundle install --jobs=4 --retry=3 --path vendor/bundle\n\n      - save_cache:\n          paths:\n            - ./vendor/bundle\n          key: v1-dependencies-{{ checksum \"Gemfile.lock\" }}\n\n      # run tests!\n      - run:\n          name: run tests\n          command: |\n            bundle exec cucumber features/ -p remote LOCATION=GB\n\n      # collect reports\n      - store_test_results:\n          path: /tmp\n      - store_artifacts:\n          path: /reports\n\nworkflows:\n  version: 2\n  nightly:\n    triggers:\n      - schedule:\n          cron: '0 4 * * 1-5'\n          filters:\n            branches:\n              only:\n                - master\n    jobs:\n      - test:\n          context: featuretests\n```\n\nAfter you finish with the job section, create nightly workflow that runs on a schedule. Set the time when the job should be triggered in the `cron` field and set the branch with the code you want executed. In the `job` field declare you want this workflow to run the job set up above, i.e. `test` and in the `context` field set the name set in CircleCI with all project secrets.\n\n## Feature-tests\n\nJust like in the example above we start with creating job which we'll use in the workflow section. But unlike in the previous example we won't run the tests from their own repo but instead they'll be called externally from the repository of the app we're testing. My first attempt was to create steps to pull, bundle and execute tests but it failed because of the way CircleCI handles ssh keys. I have tried setting up the keys in a step as described in the docs but it didn't work.\n\n```yml\nsteps:\n  - add_ssh_keys:\n      fingerprints:\n        - 'SO:ME:FIN:G:ER:PR:IN:T'\n```\n\nMy assumption was that during build the job will use the ssh keys set in the circleci project secrets section if no fingerprints field present in the steps and once it gets to a step with fingerprints it will use the ones provided. It turns out that if there are ssh keys set CircleCI doesn't look for any other and uses the same set for authentications. I already had a docker image for my tests and all I had to do was to pull my image and use it to spin a container for my tests. The rest of the steps are similar to the nightly example except the caching and installation of dependencies.\n\n```yml\nfeature-tests:\n  docker:\n    - image: name-of-your-image.xxx.xxx.eu-west-1.amazonaws.com/feature-tests:latest\n  working_directory: /app\n  steps:\n    - run:\n        name: run tests\n        command: |\n          bundle exec cucumber features/app_under_test\n    # collect reports\n    - store_test_results:\n        path: /tmp\n    - store_artifacts:\n        path: /reports\n```\n\nOnce the job was defined I was ready to include it in the project workflow. I wanted my tests to run once the application under test was deployed to staging. To do so I used the `requires` field and set it up to `deploy` and also specified in filters > branches that I only want to run the tests when the application is deployed in staging.\n\n```yml\n# /.circleci/config.yml\nversion: 2\nworkflows:\n  version: 2\n  build_test_deploy:\n    jobs:\n      - deploy:\n          context: aws\n          filters:\n            branches:\n              only:\n                - staging\n                - production\n      - feature-tests:\n          requires:\n            - deploy\n          context: featuretests\n          filters:\n            branches:\n              only:\n                - staging\n```\n\nWhen you work on the config file be very careful with the indentation. Before trying your config live you can run validation if you have CircleCI's cli installed, i.e. `circleci config validate`. Using the cli you can also run the build locally. For more information go to [local-cli](https://circleci.com/docs/2.0/local-cli/).\n\nComplete file `config.yml`:\n\n```yml\nversion: 2\nworkflows:\n  version: 2\n  build_test_deploy:\n    jobs:\n      - deploy:\n          context: aws\n          filters:\n            branches:\n              only:\n                - staging\n                - production\n      - feature-tests:\n          requires:\n            - deploy\n          context: featuretests\n          filters:\n            branches:\n              only:\n                - staging\njobs:\n  deploy:\n    docker:\n      - image: application-image.xxx.xxx.eu-west-1.amazonaws.com/node:latest\n    working_directory: ~/code\n    steps:\n      - checkout\n      - restore_cache: # special step to restore the dependency cache\n          key: dependency-cache-{{ checksum \"yarn.lock\" }}\n      - run:\n          name: yarn\n          command: yarn --no-progress\n      - save_cache: # special step to save the dependency cache\n          key: dependency-cache-{{ checksum \"yarn.lock\" }}\n          paths:\n            - ./node_modules\n      - run:\n          name: node-sass\n          command: npm rebuild node-sass\n      - run:\n          name: yarn test\n          command: yarn test\n      - run:\n          name: yarn build\n          command: NODE_ENV=$CIRCLE_BRANCH yarn build\n      - run:\n          name: deploy\n          command: ./deploy.sh\n  feature-tests:\n    docker:\n      - image: feat-tests-image.xxx.xxx.eu-west-1.amazonaws.com/feature-tests:latest\n    working_directory: /app\n    steps:\n      - run:\n          name: run tests\n          command: |\n            bundle exec cucumber features/application_under_test\n      # collect reports\n      - store_test_results:\n          path: /tmp\n      - store_artifacts:\n          path: /reports\n```\n"}},"__N_SSG":true}