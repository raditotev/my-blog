{"pageProps":{"post":{"id":"gallery-with-rails-5-paperclip-and-blueimp","title":"Gallery with Rails 5, Paperclip and blueimp","date":"2016-10-16T00:00:00.000Z","description":"Building a gallery with Rails 5, Paperclip for image processing and blueimp for JS image interaction.","categories":["rails","gallery","ruby","paperclip"],"markdown":"\nRecently I had to build a gallery with Rails and it took me a few days finding solutions to my problems on the web. This article is the result of everything I found, put together. I'll keep it as brief as possible and if you have any questions please drop me an email and I'll try to explain as best as I can.\n\nAlright, enough chit chat let's roll our sleeves. First we have to create our new project.\n\n```bash\nrails new gallery -T\n```\n\nSweet. Next we'll update our Gemfile\n\n```ruby\n# Gemfile\n\n# File upload\ngem \"paperclip\", \"~> 5.0.0\"\n# Forms\ngem 'simple_form'\n#Bootstrap\ngem 'bootstrap-sass', '~> 3.3.6'\n\n```\n\nRun bundle install.  \nInstall simple_form.\n\n```bash\nrails generate simple_form:install\n```\n\nChange the name of your application.css to application.scss and import bootstrap.\n\n```css\n/* application.scss */\n\n@import 'bootstrap-sprockets';\n@import 'bootstrap';\n```\n\nNow that we have all the gems it's time to create our resources. We'll need models and two controllers for Album and Photo. For the Album we'll need all controller actions and for the Photo only destroy action.\nLet's start with the Album first.\n\n```bash\nrails g scaffold Album name description\n```\n\nThis creates the controller, the model and prepares the table for us.\nLet's create the controller, model and table for our Photos. We'll need only destroy action, so we run the following generator:\n\n```bash\nrails g controller Photos destroy\n```\n\nAnd for the model:\n\n```bash\nrails g model Photo name imageable:references\n```\n\nI've created Photo as polymorphic model for the needs of my project and I'll leave it as polymorphic for this project. It's good to see how polymorphic models are used if you haven't done it before.\nBefore we run the migration and create the tables, there are some changes we have to do for the photos table.\n\n```ruby\n#db/migrations/xxxxxxxxxxxxx_create_photos.rb\n\nt.string :name\nt.string :description\nt.references :imageable, polymorphic: true, index: true\n```\n\nChange the foreign_key: true for polymorphic: true, index: true. This will create the necessary columns for us.\n\n```ruby\nrails db:migrate\n```\n\nHaving the tables ready, it's time to add the fields for paperclip. The simplest way is to run paperclip's generator.\n\n```bash\nrails generate paperclip photo image\n```\n\nAnd `rails db:migrate` again to add the new columns for paperclip to the photos table.\nNow update the models.\n\n```ruby\n# album.rb\n\nhas_many :photos, as: :imageable, dependent: :destroy\nvalidates_presence_of :name\ndefault_scope -> { order(created_at: :desc) }\n```\n\n```ruby\n# photo.rb\n\nbelongs_to :imageable, polymorphic: true\n\nhas_attached_file :image,\n  styles: { medium: \"300x300>\", thumb: \"100x100>\" },\n  default_url: \"/images/:style/missing.png\"\nvalidates_attachment_content_type :image, content_type: /image\\/.*\\z/\n```\n\nWhen we run the generator for the Photos controller, rails has automatically created a new route for us but it doesn't do what we need. Change with the code from the snippet below.\n\n```ruby\n# routes.rb\n\nroot to: \"albums#index\"\ndelete 'photo/:id' => 'photos#destroy', as: 'photo'\n```\n\nNext step will be to update the form partial for the Albums using simple form and rails's file_field_tag for the file attachments. We set the form to be multipart and the file_filed in order to select multiple files. All selected files will be wrapped in an array and passed to the params as key images.\n\n```erb\n<!-- albums/_form.html.erb -->\n\n<%= simple_form_for(album, html: {multipart: true}) do |f| %>\n\n  <%= f.input :name %>\n\n  <%= f.input \"Choose photos\" do %>\n    <%= file_field_tag \"images[]\", type: :file, multiple: true %>\n  <% end %>\n\n  <%= f.button :submit %>\n<% end %>\n```\n\nUpdate the albums_controller to get the array with the images from the params and add them to the given album.\n\n```ruby\n#albums_controller.rb\n\ndef create\n  @album = Album.new(album_params)\n\n  respond_to do |format|\n    if @album.save\n\n      #Add lines bellow\n      if params[:images]\n        params[:images].each { |image|\n        @album.photos.create(image: image)\n      }\n    end\n\n      format.html { redirect_to @album, notice: 'Album was successfully created.' }\n      format.json { render :show, status: :created, location: @album }\n    else\n      format.html { render :new }\n      format.json { render json: @album.errors, status: :unprocessable_entity }\n    end\n  end\nend\n```\n\nIt's time to fire up the server and see if what we've done so far is working. Go to the new album and create one with a few photos. Everything works fine and we're redirected to the show page but only the album name is visible. Let's change that. Add the following div just above the links at the bottom. Refresh and hurray, we've got our photos!\n\n```erb\n<!-- albums/show.html.erb -->\n\n<div>\n  <% @album.photos.each do |photo| %>\n        <%= link_to image_tag(photo.image.url(:medium)), photo.image.url, data: { gallery: ''} %>\n        <% end %>\n</div>\n```\n\nNext thing I want to change is when I create a new album and select files, instead of just seeing the number of files selected I want to have some visual representation. Place a holder in the form.\n\n```erb\n<!-- albums/_form.html.erb -->\n\n<%= f.input :name %>\n\n<div id=\"image-preview\"></div> <!-- Add this line -->\n\n<%= f.input \"Choose photos\" do %>\n```\n\nAnd add the required javascript.\n\n```js\n// application.js\n\nvar ready;\nready = function () {\n  // Photo preview on album create\n  var preview = $('#image-preview');\n  $('#images_').change(function (event) {\n    var input = $(event.currentTarget);\n    var files = input[0].files;\n    for (var i = 0; i < files.length; i++) {\n      var file = files[i];\n      var reader = new FileReader();\n      reader.onload = function (e) {\n        image_base64 = e.target.result;\n        var html = '<img src=' + image_base64 + \" style='max-width: 200px;'>\";\n        preview.append(html);\n      };\n      reader.readAsDataURL(file);\n    }\n  });\n  // Clear images when Browse is clicked again\n  $('#images_').click(function () {\n    $('#image-preview img').remove();\n  });\n};\n\n$(document).on('turbolinks:load', ready);\n```\n\nI have two functions. One is to show the selected files. The other one is to clear them from the screen in case the user decides to change his selection.\n\nAnother change to the form will be to display all album photos when we update an existing album and provide a button in case the user wants to delete a photo or photos from the collection.\n\n```erb\n<!-- _form.html.erb -->\n\n<%= f.input :name %>\n\n<% if @album.photos.any? %>\n  <div id=\"images\">\n    <% @album.photos.each do |photo| %>\n      <div id=\"photo-<%= photo.id %>\" class=\"image\">\n        <%= link_to photo, method: :delete,\n                          data: { confirm: 'Are you sure?' },\n                          class: \"delete-image\",\n                          remote: true,\n                          title: \"Delete Image\" do %>\n            <i class=\"glyphicon glyphicon-remove-circle\"></i>\n          <% end %>\n        <%= image_tag photo.image.url(:medium) %>\n      </div>\n    <% end %>\n  </div>\n<% end %>\n\n<!--\nAdd before this div\n<div id=\"image-preview\"></div>\n-->\n```\n\nTo position all buttons add styling as follows:\n\n```css\n/* application.scss */\n\n.image {\n  display: inline-block;\n  position: relative;\n}\n\n.delete-image {\n  position: absolute;\n  top: 5px;\n  right: 5px;\n  color: red;\n}\n```\n\nIt's time to add some code to our photos controller.\n\n```ruby\n# photos_controller.rb\n\ndef destroy\n  photo = Photo.find(params[:id])\n  @id = photo.id\n  photo.destroy\n  respond_to :js\nend\n```\n\nCreate a new file views/photos/destroy.js.erb and add this code. This will look for a div with the id of the photo being deleted and will remove it from the screen.\n\n```js\n// destroy.js.erb\n\n$('#photo-<%= @id %>').fadeOut();\n```\n\nNow, let's update our albums controller in case our user wants to add some photos instead of removing them. Again we'll get all the photos being uploaded from the params[:images], but this time instead of blindly creating photos we have to check for duplicates first.\n\n```ruby\n# albums_controller.rb\n\ndef update\n  respond_to do |format|\n    if @album.update(album_params)\n\n    if params[:images]\n        params[:images].each do |image|\n          existing_image = @album.photos.find {|photo| photo.image_file_name ==\n                                                                                            image.original_filename}\n          @album.photos.create(image: image) unless existing_image\n      end\n    end\n\n      format.html { redirect_to @album, notice: 'Album was successfully updated.' }\n      format.json { render :show, status: :ok, location: @album }\n    else\n      format.html { render :edit }\n      format.json { render json: @album.errors, status: :unprocessable_entity }\n    end\n  end\nend\n```\n\nOur form is working now for new albums and editing existing. It's time to beautify the way images are displayed on the show page. I'll use blueimp's gallery. Go to https://github.com/blueimp/Gallery and download blueimp-gallery.css and blueimp-gallery-indicator.css in your stylesheets directory. Include those in your application.scss.\n\n```css\n/* application.scss */\n\n@import 'blueimp-gallery';\n@import 'blueimp-gallery-indicator';\n```\n\nThen download blueimp-gallery.js to your javascripts directory and include it in your application.js.\n\n```js\n// application.js\n\n// After turbolinks add\n//= require blueimp-gallery\n```\n\nOpen blueimp-gallery.css and update all urls for loading.gif, error.png, play-pause.png, error.svg and play-pause.svg. A valid url for image in rails looks like this:\n\n```css\nbackground: url('loading.gif');\n```\n\nAlso download all the images from blueimp/Gallery/img in your app/assets/images folder.\n\nNow all we have to do is add a snippet of code and our gallery will spring to life. Wrap our code from before in a div tag with an id \"links\" and add the code snippet for the modal at the bottom of the page. It is IMPORTANT to place this snippet as a direct descendant of the body. If your yield in the application is wrapped in a div or another tag, place the snippet on application.html.erb directly in the body. You can also import it as a partial.\n\n```erb\n<!-- show.html.erb -->\n\n<div class=\"container\">\n  <div id=\"links\">\n    <% @album.photos.each do |photo| %>\n        <%= link_to image_tag(photo.image.url(:medium)), photo.image.url, data: { gallery: ''} %>\n        <% end %>\n  </div>\n</div>\n\n<!-- The Gallery as lightbox dialog, should be a child element of the document body -->\n<div id=\"blueimp-gallery\" class=\"blueimp-gallery blueimp-gallery-controls\">\n    <div class=\"slides\"></div>\n    <h3 class=\"title\"></h3>\n    <a class=\"prev\">‹</a>\n    <a class=\"next\">›</a>\n    <a class=\"close\">×</a>\n    <a class=\"play-pause\"></a>\n    <ol class=\"indicator\"></ol>\n</div>\n```\n\nAdd the onclick handler for the images, right after the second function handling the Browse click.\n\n```js\n// Clear images when Browse is clicked again\n//  $(\"#images_\").click(function(){\n//    $(\"#image-preview img\").remove();\n//  });\n\n//After above function\n\n// Blueimp Light Box\ndocument.getElementById('links').onclick = function (event) {\n  event = event || window.event;\n  var target = event.target || event.srcElement,\n    link = target.src ? target.parentNode : target,\n    options = { index: link, event: event },\n    links = this.getElementsByTagName('a');\n  blueimp.Gallery(links, options);\n};\n```\n\nOur gallery is ready and looks great :) Unfortunately I can't say the same for the rest of the pages. I won't go crazy but I would like to add some basic styling for our pages. I'll start with the application.html.erb and move our notices from index and show in there along with some bootstrap styling.\n\n```erb\n<!-- application.html.erb -->\n\n<!-- Add after body and before yield -->\n<% if notice %>\n  <div id=\"notice\" class=\"alert alert-info alert-dismissible\" role=\"alert\">\n    <button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>\n    <%= notice %>\n  </div>\n<% end %>\n```\n\nAdd bootstrap-sprockets after jquery in order for our dismiss button to work.\n\n```js\n// application.js\n\n// after require jquery\n//= require bootstrap-sprockets\n```\n\n```css\n/* application.scss */\n\n#notice {\n  width: 50%;\n  text-align: center;\n  margin: 10px auto;\n}\n```\n\n```erb\n<!-- index.html.erb -->\n\n<!-- Remove <p id=\"notice\"><%= notice %></p> -->\n```\n\n```erb\n<!-- show.html.erb\n\n Remove <p id=\"notice\"><%= notice %></p>\n-->\n```\n\nIn application.html.erb I'll add a header.\n\n```erb\n\n<!-- application.html.erb -->\n\n<section>\n  <div class=\"container\">\n      <h1 class=\"text-right\"><%= link_to \"Gallery\", root_url %></h1>\n  </div>\n</section>\n```\n\nSome styling for our index page with out of the box bootstrap.\n\n```erb\n<!-- index.html.erb -->\n\n<h2 class=\"text-center\"><%= link_to 'New Album', new_album_path %></h2>\n\n<div class=\"container\">\n  <div class=\"row\">\n    <% @albums.each do |album| %>\n      <div class=\"col-sm-6 col-md-4\">\n        <div class=\"thumbnail\">\n          <% if album.photos.any? %>\n            <%= link_to image_tag(album.photos.first.image.url(:medium)), album %>\n          <% end %>\n          <div class=\"caption\">\n            <h3 class=\"text-center\"><%= album.name %></h3>\n            <p><%= album.description %></p>\n            <p>\n              <%= link_to \"Edit\", edit_album_path(album), class: \"btn btn-warning\" %>\n              <%= link_to \"Delete\", album, class: \"btn btn-danger pull-right\",\n                                           method: :delete,\n                                           data: { confirm: 'Are you sure?' } %>\n             </p>\n          </div>\n        </div>\n      </div>\n    <% end %>\n  </div>\n</div>\n```\n\nIn show.html remove the rails generated links.\n\n```erb\n<!-- show.html.erb -->\n\nremove <%= link_to 'Edit', edit_album_path(@album) %> |\n <%= link_to 'Back', albums_path %>\n```\n\nPlace new and edit pages in the container.\n\n```erb\n<!-- new.html.erb -->\n\n<h1 class=\"text-center\">New Album</h1>\n\n<div class=\"container\">\n  <%= render 'form', album: @album %>\n</div>\n```\n\n```erb\n<!-- edit.html.erb -->\n\n<h1 class=\"text-center\">Editing Album</h1>\n\n<div class=\"container\">\n  <%= render 'form', album: @album %>\n</div>\n```\n\nAnd the final styling.\n\n```css\n/* application.scss */\n\n/* Styling for the header section */\n@import url('https://fonts.googleapis.com/css?family=Sansita+One');\n\n\nsection{\n  height: 100px;\n  background-color:   #154890;\n  a, a:hover{\n    font-family: 'Sansita One', cursive;\n    color:  #F5EDE3;\n    font-size: 50px;\n    font-weight: 700;\n    text-decoration: none;\n  }\n}\n\n/* Styling for the Edit page */\n\n.image{\n  ..\n  ..\n  height: 200px;\n}\n\nform{\n  label{\n    display: block;\n  }\n  div{\n    margin-top: 15px;\n    margin-bottom: 15px;\n  }\n  img{\n    margin: 5px;\n  }\n  #album_name{\n    width: 50%;\n  }\n}\n\n/* Styling for the index, show and edit pages */\n\nh2{\n  margin: 30px auto;\n}\n```\n\nThat's it. Our gallery project is done. I'll throw a few screenshots for those of you who didn't do it.\n\n![Gallery screenshot](http://s3.amazonaws.com/my-personal-page-static-content/app/public/ckeditor_assets/pictures/13/content_index.png#center)\n![Gallery screenshot](http://s3.amazonaws.com/my-personal-page-static-content/app/public/ckeditor_assets/pictures/12/content_new.png#center)\n![Gallery screenshot](http://s3.amazonaws.com/my-personal-page-static-content/app/public/ckeditor_assets/pictures/9/content_edit.png#center)\n![Gallery screenshot](http://s3.amazonaws.com/my-personal-page-static-content/app/public/ckeditor_assets/pictures/16/content_show.png#center)\n"}},"__N_SSG":true}