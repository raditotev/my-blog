<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="og:title" content="Set up automation tests in CircleCI" class="jsx-eb7a88ca53252729"/><title class="jsx-eb7a88ca53252729">Set up automation tests in CircleCI</title><meta name="next-head-count" content="4"/><link rel="icon" href="/favicon/favicon.ico"/><meta name="description" content="A collection of technical posts."/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-H1DT8LBE3Y"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-H1DT8LBE3Y');
          </script><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-f65e66e62fc5ca80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-02d0f4839caa4a8e.js" defer=""></script><script src="/_next/static/chunks/83-7030382a9597fa38.js" defer=""></script><script src="/_next/static/chunks/32-1cf93db441761c8a.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-7655989d47098e38.js" defer=""></script><script src="/_next/static/YfngYCKqE4veWCi3zrSBC/_buildManifest.js" defer=""></script><script src="/_next/static/YfngYCKqE4veWCi3zrSBC/_ssgManifest.js" defer=""></script><script src="/_next/static/YfngYCKqE4veWCi3zrSBC/_middlewareManifest.js" defer=""></script><style id="__jsx-fdefdd4b6c4ce2c4">span.jsx-fdefdd4b6c4ce2c4{color:#333;font-size:.9rem}</style><style id="__jsx-7814f24efc48ee15">.list-categories.jsx-7814f24efc48ee15 a.jsx-7814f24efc48ee15{color:#333;text-transform:uppercase;font-size:.6rem;font-weight:700;margin-right:10px}</style><style id="__jsx-eb7a88ca53252729">.post.jsx-eb7a88ca53252729{width:100%}header.jsx-eb7a88ca53252729{text-align:center;margin-bottom:3rem}.post.jsx-eb7a88ca53252729 h1.jsx-eb7a88ca53252729{margin-bottom:.2rem}a.jsx-eb7a88ca53252729{color:black}footer.jsx-eb7a88ca53252729{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-moz-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}footer.jsx-eb7a88ca53252729 a.go-back.jsx-eb7a88ca53252729{font-size:1.5rem}@media(max-width:820px){footer.jsx-eb7a88ca53252729{display:block}footer.jsx-eb7a88ca53252729 a.go-back.jsx-eb7a88ca53252729{float:right}}</style><style id="__jsx-5cae0e9dd922305c">html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-size:20px}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}p{font-weight:400;line-height:32px}a{text-decoration:none}img{width:100%}img[src*="#center"]{display:block;margin:auto}@media(max-width:820px){body{font-size:18px}p{line-height:28px}img{max-width:80vw}}</style><style id="__jsx-53df2e978e8b299a">header.jsx-5a195dee6678eb3{width:100vw;padding:1.7rem;background-color:rgba(0,0,0,.9);text-align:center}header.jsx-5a195dee6678eb3 h1.jsx-5a195dee6678eb3{margin:0}header.jsx-5a195dee6678eb3 a.jsx-5a195dee6678eb3{text-decoration:none;color:crimson}main.jsx-5a195dee6678eb3{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-moz-box-orient:vertical;-moz-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-moz-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:20px auto;max-width:820px}@media(max-width:820px){main.jsx-5a195dee6678eb3{width:95vw}}</style></head><body><div id="__next" data-reactroot=""><div class="jsx-5a195dee6678eb3"><header class="jsx-5a195dee6678eb3"><div class="jsx-5a195dee6678eb3"><a class="jsx-5a195dee6678eb3" href="/"><h1 class="jsx-5a195dee6678eb3">Radi&#x27;s Blog</h1></a></div></header><main class="jsx-5a195dee6678eb3"><div class="jsx-eb7a88ca53252729 post"><header class="jsx-eb7a88ca53252729"><h1 class="jsx-eb7a88ca53252729">Set up automation tests in CircleCI</h1><span class="jsx-fdefdd4b6c4ce2c4"><time dateTime="2018-12-09T00:00:00.000Z" class="jsx-fdefdd4b6c4ce2c4">9 December 2018</time></span></header><p>Recently the company I work for moved the CI/CD from Shippable to CircleCI. This is a quick guide on how to create a job and workflow.I have created two different workflows for my needs . One called <strong>nightly</strong> running all tests from the feature tests repo every day from Monday to Friday at 4am and one used externally from the application under test workflow called <strong>feature-tests</strong>.</p>
<h2>Nightly</h2>
<p>First create the job. I have called mine tests. Then I specified the base docker image I want to use for the job, i.e. <code style="font-size:1rem;color:crimson">circleci/ruby:2.5-browsers-legacy</code>. I won&#x27;t go in too much detail for all the steps because they will be generated automatically for you once you add you automation tests in CircleCI (for more information see <a href="https://circleci.com/docs/2.0/project-build/#section=getting-started">here</a>). The most important thing to know about the job is that you&#x27;ll have to use bundle install cucumber instead of just cucumber because all gems will be installed in a custom location <code style="font-size:1rem;color:crimson">bundle install --jobs=4 --retry=3 --path vendor/bundle</code>. The other tip is to specify the path where the test reports can be found after completion - <code style="font-size:1rem;color:crimson">store_test_results: path: /tmp</code>. Make sure the path set is the same as the one you have in <code style="font-size:1rem;color:crimson">cucumber.yml</code>. Also make sure the output format is junit so you can see the number of passing and failing tests at first glance in the tab <strong>Results</strong> after the job is finished.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-yml" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># /.circleci/config.yml</span><span>
</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># Ruby CircleCI 2.0 configuration file</span><span>
</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">#</span><span>
</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># Check https://circleci.com/docs/2.0/language-ruby/ for more details</span><span>
</span><span></span><span class="token" style="color:rgb(99, 119, 119);font-style:italic">#</span><span>
</span><span></span><span class="token key" style="color:rgb(255, 203, 139)">jobs</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">test</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">docker</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">image</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> circleci/ruby</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>2.5</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>browsers</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>legacy
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">working_directory</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> ~/repo
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">steps</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> checkout
</span><span>      </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># Download and cache dependencies</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">restore_cache</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">keys</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> v1</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>dependencies</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span> checksum &quot;Gemfile.lock&quot; </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span>            </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># fallback to using the latest cache if no exact match is found</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> v1</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>dependencies</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>
</span>
<span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> install dependencies
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">|</span><span class="token scalar" style="color:rgb(173, 219, 103)">
</span><span class="token scalar" style="color:rgb(173, 219, 103)">            bundle install --jobs=4 --retry=3 --path vendor/bundle</span><span>
</span>
<span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">save_cache</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">paths</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> ./vendor/bundle
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">key</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> v1</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>dependencies</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span> checksum &quot;Gemfile.lock&quot; </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span>
<span>      </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># run tests!</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> run tests
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">|</span><span class="token scalar" style="color:rgb(173, 219, 103)">
</span><span class="token scalar" style="color:rgb(173, 219, 103)">            bundle exec cucumber features/ -p remote LOCATION=GB</span><span>
</span>
<span>      </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># collect reports</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_test_results</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /tmp
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_artifacts</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /reports
</span>
<span></span><span class="token key" style="color:rgb(255, 203, 139)">workflows</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">version</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">nightly</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">triggers</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">schedule</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">cron</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(173, 219, 103)">&#x27;0 4 * * 1-5&#x27;</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">filters</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token key" style="color:rgb(255, 203, 139)">branches</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>              </span><span class="token key" style="color:rgb(255, 203, 139)">only</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> master
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">jobs</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">test</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">context</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> featuretests</span></code></div></pre>
<p>After you finish with the job section, create nightly workflow that runs on a schedule. Set the time when the job should be triggered in the <code style="font-size:1rem;color:crimson">cron</code> field and set the branch with the code you want executed. In the <code style="font-size:1rem;color:crimson">job</code> field declare you want this workflow to run the job set up above, i.e. <code style="font-size:1rem;color:crimson">test</code> and in the <code style="font-size:1rem;color:crimson">context</code> field set the name set in CircleCI with all project secrets.</p>
<h2>Feature-tests</h2>
<p>Just like in the example above we start with creating job which we&#x27;ll use in the workflow section. But unlike in the previous example we won&#x27;t run the tests from their own repo but instead they&#x27;ll be called externally from the repository of the app we&#x27;re testing. My first attempt was to create steps to pull, bundle and execute tests but it failed because of the way CircleCI handles ssh keys. I have tried setting up the keys in a step as described in the docs but it didn&#x27;t work.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-yml" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token key" style="color:rgb(255, 203, 139)">steps</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">add_ssh_keys</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token key" style="color:rgb(255, 203, 139)">fingerprints</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>        </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token" style="color:rgb(173, 219, 103)">&#x27;SO:ME:FIN:G:ER:PR:IN:T&#x27;</span></code></div></pre>
<p>My assumption was that during build the job will use the ssh keys set in the circleci project secrets section if no fingerprints field present in the steps and once it gets to a step with fingerprints it will use the ones provided. It turns out that if there are ssh keys set CircleCI doesn&#x27;t look for any other and uses the same set for authentications. I already had a docker image for my tests and all I had to do was to pull my image and use it to spin a container for my tests. The rest of the steps are similar to the nightly example except the caching and installation of dependencies.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-yml" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token key" style="color:rgb(255, 203, 139)">feature-tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">docker</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">image</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> name</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>of</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>your</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>image.xxx.xxx.eu</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>west</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>1.amazonaws.com/feature</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>latest
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">working_directory</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /app
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">steps</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>        </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> run tests
</span><span>        </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">|</span><span class="token scalar" style="color:rgb(173, 219, 103)">
</span><span class="token scalar" style="color:rgb(173, 219, 103)">          bundle exec cucumber features/app_under_test</span><span>
</span><span>    </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># collect reports</span><span>
</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_test_results</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>        </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /tmp
</span><span>    </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_artifacts</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>        </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /reports</span></code></div></pre>
<p>Once the job was defined I was ready to include it in the project workflow. I wanted my tests to run once the application under test was deployed to staging. To do so I used the <code style="font-size:1rem;color:crimson">requires</code> field and set it up to <code style="font-size:1rem;color:crimson">deploy</code> and also specified in filters &gt; branches that I only want to run the tests when the application is deployed in staging.</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-yml" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># /.circleci/config.yml</span><span>
</span><span></span><span class="token key" style="color:rgb(255, 203, 139)">version</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span></span><span class="token key" style="color:rgb(255, 203, 139)">workflows</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">version</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">build_test_deploy</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">jobs</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">deploy</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">context</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> aws
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">filters</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token key" style="color:rgb(255, 203, 139)">branches</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>              </span><span class="token key" style="color:rgb(255, 203, 139)">only</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> staging
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> production
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">feature-tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">requires</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> deploy
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">context</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> featuretests
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">filters</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token key" style="color:rgb(255, 203, 139)">branches</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>              </span><span class="token key" style="color:rgb(255, 203, 139)">only</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> staging</span></code></div></pre>
<p>When you work on the config file be very careful with the indentation. Before trying your config live you can run validation if you have CircleCI&#x27;s cli installed, i.e. <code style="font-size:1rem;color:crimson">circleci config validate</code>. Using the cli you can also run the build locally. For more information go to <a href="https://circleci.com/docs/2.0/local-cli/">local-cli</a>.</p>
<p>Complete file <code style="font-size:1rem;color:crimson">config.yml</code>:</p>
<pre><div style="color:white;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;background:#011627"><code class="language-yml" style="color:#d6deeb;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:1em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token key" style="color:rgb(255, 203, 139)">version</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span></span><span class="token key" style="color:rgb(255, 203, 139)">workflows</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">version</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(247, 140, 108)">2</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">build_test_deploy</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">jobs</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">deploy</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">context</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> aws
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">filters</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token key" style="color:rgb(255, 203, 139)">branches</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>              </span><span class="token key" style="color:rgb(255, 203, 139)">only</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> staging
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> production
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">feature-tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">requires</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> deploy
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">context</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> featuretests
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">filters</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token key" style="color:rgb(255, 203, 139)">branches</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>              </span><span class="token key" style="color:rgb(255, 203, 139)">only</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>                </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> staging
</span><span></span><span class="token key" style="color:rgb(255, 203, 139)">jobs</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">deploy</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">docker</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">image</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> application</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>image.xxx.xxx.eu</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>west</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>1.amazonaws.com/node</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>latest
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">working_directory</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> ~/code
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">steps</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> checkout
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">restore_cache</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># special step to restore the dependency cache</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">key</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> dependency</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>cache</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span> checksum &quot;yarn.lock&quot; </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> yarn
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> yarn </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>no</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>progress
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">save_cache</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># special step to save the dependency cache</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">key</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> dependency</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>cache</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span class="token" style="color:rgb(199, 146, 234)">{</span><span> checksum &quot;yarn.lock&quot; </span><span class="token" style="color:rgb(199, 146, 234)">}</span><span class="token" style="color:rgb(199, 146, 234)">}</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">paths</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>            </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> ./node_modules
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> node</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>sass
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> npm rebuild node</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>sass
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> yarn test
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> yarn test
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> yarn build
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> NODE_ENV=$CIRCLE_BRANCH yarn build
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> deploy
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> ./deploy.sh
</span><span>  </span><span class="token key" style="color:rgb(255, 203, 139)">feature-tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">docker</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">image</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> feat</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>tests</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>image.xxx.xxx.eu</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>west</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>1.amazonaws.com/feature</span><span class="token" style="color:rgb(199, 146, 234)">-</span><span>tests</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>latest
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">working_directory</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /app
</span><span>    </span><span class="token key" style="color:rgb(255, 203, 139)">steps</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">run</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">name</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> run tests
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">command</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> </span><span class="token" style="color:rgb(199, 146, 234)">|</span><span class="token scalar" style="color:rgb(173, 219, 103)">
</span><span class="token scalar" style="color:rgb(173, 219, 103)">            bundle exec cucumber features/application_under_test</span><span>
</span><span>      </span><span class="token" style="color:rgb(99, 119, 119);font-style:italic"># collect reports</span><span>
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_test_results</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /tmp
</span><span>      </span><span class="token" style="color:rgb(199, 146, 234)">-</span><span> </span><span class="token key" style="color:rgb(255, 203, 139)">store_artifacts</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span>
</span><span>          </span><span class="token key" style="color:rgb(255, 203, 139)">path</span><span class="token" style="color:rgb(199, 146, 234)">:</span><span> /reports</span></code></div></pre><footer class="jsx-eb7a88ca53252729"><div class="jsx-7814f24efc48ee15 list-categories"><a class="jsx-7814f24efc48ee15" href="/categories/devops">devops</a><a class="jsx-7814f24efc48ee15" href="/categories/circleci">circleci</a><a class="jsx-7814f24efc48ee15" href="/categories/ruby">ruby</a></div><a class="jsx-eb7a88ca53252729 go-back" href="/">🏠</a></footer></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":"set-up-automation-tests-in-circleci","title":"Set up automation tests in CircleCI","date":"2018-12-09T00:00:00.000Z","description":"Description of the work done integrating e2e test in the CircleCI CI/CD. Article contains also yaml file for each of the jobs discussed.","categories":["devops","circleci","ruby"],"markdown":"\nRecently the company I work for moved the CI/CD from Shippable to CircleCI. This is a quick guide on how to create a job and workflow.I have created two different workflows for my needs . One called **nightly** running all tests from the feature tests repo every day from Monday to Friday at 4am and one used externally from the application under test workflow called **feature-tests**.\n\n## Nightly\n\nFirst create the job. I have called mine tests. Then I specified the base docker image I want to use for the job, i.e. `circleci/ruby:2.5-browsers-legacy`. I won't go in too much detail for all the steps because they will be generated automatically for you once you add you automation tests in CircleCI (for more information see [here](https://circleci.com/docs/2.0/project-build/#section=getting-started)). The most important thing to know about the job is that you'll have to use bundle install cucumber instead of just cucumber because all gems will be installed in a custom location `bundle install --jobs=4 --retry=3 --path vendor/bundle`. The other tip is to specify the path where the test reports can be found after completion - `store_test_results: path: /tmp`. Make sure the path set is the same as the one you have in `cucumber.yml`. Also make sure the output format is junit so you can see the number of passing and failing tests at first glance in the tab **Results** after the job is finished.\n\n```yml\n# /.circleci/config.yml\n# Ruby CircleCI 2.0 configuration file\n#\n# Check https://circleci.com/docs/2.0/language-ruby/ for more details\n#\njobs:\n  test:\n    docker:\n      - image: circleci/ruby:2.5-browsers-legacy\n    working_directory: ~/repo\n    steps:\n      - checkout\n      # Download and cache dependencies\n      - restore_cache:\n          keys:\n            - v1-dependencies-{{ checksum \"Gemfile.lock\" }}\n            # fallback to using the latest cache if no exact match is found\n            - v1-dependencies-\n\n      - run:\n          name: install dependencies\n          command: |\n            bundle install --jobs=4 --retry=3 --path vendor/bundle\n\n      - save_cache:\n          paths:\n            - ./vendor/bundle\n          key: v1-dependencies-{{ checksum \"Gemfile.lock\" }}\n\n      # run tests!\n      - run:\n          name: run tests\n          command: |\n            bundle exec cucumber features/ -p remote LOCATION=GB\n\n      # collect reports\n      - store_test_results:\n          path: /tmp\n      - store_artifacts:\n          path: /reports\n\nworkflows:\n  version: 2\n  nightly:\n    triggers:\n      - schedule:\n          cron: '0 4 * * 1-5'\n          filters:\n            branches:\n              only:\n                - master\n    jobs:\n      - test:\n          context: featuretests\n```\n\nAfter you finish with the job section, create nightly workflow that runs on a schedule. Set the time when the job should be triggered in the `cron` field and set the branch with the code you want executed. In the `job` field declare you want this workflow to run the job set up above, i.e. `test` and in the `context` field set the name set in CircleCI with all project secrets.\n\n## Feature-tests\n\nJust like in the example above we start with creating job which we'll use in the workflow section. But unlike in the previous example we won't run the tests from their own repo but instead they'll be called externally from the repository of the app we're testing. My first attempt was to create steps to pull, bundle and execute tests but it failed because of the way CircleCI handles ssh keys. I have tried setting up the keys in a step as described in the docs but it didn't work.\n\n```yml\nsteps:\n  - add_ssh_keys:\n      fingerprints:\n        - 'SO:ME:FIN:G:ER:PR:IN:T'\n```\n\nMy assumption was that during build the job will use the ssh keys set in the circleci project secrets section if no fingerprints field present in the steps and once it gets to a step with fingerprints it will use the ones provided. It turns out that if there are ssh keys set CircleCI doesn't look for any other and uses the same set for authentications. I already had a docker image for my tests and all I had to do was to pull my image and use it to spin a container for my tests. The rest of the steps are similar to the nightly example except the caching and installation of dependencies.\n\n```yml\nfeature-tests:\n  docker:\n    - image: name-of-your-image.xxx.xxx.eu-west-1.amazonaws.com/feature-tests:latest\n  working_directory: /app\n  steps:\n    - run:\n        name: run tests\n        command: |\n          bundle exec cucumber features/app_under_test\n    # collect reports\n    - store_test_results:\n        path: /tmp\n    - store_artifacts:\n        path: /reports\n```\n\nOnce the job was defined I was ready to include it in the project workflow. I wanted my tests to run once the application under test was deployed to staging. To do so I used the `requires` field and set it up to `deploy` and also specified in filters \u003e branches that I only want to run the tests when the application is deployed in staging.\n\n```yml\n# /.circleci/config.yml\nversion: 2\nworkflows:\n  version: 2\n  build_test_deploy:\n    jobs:\n      - deploy:\n          context: aws\n          filters:\n            branches:\n              only:\n                - staging\n                - production\n      - feature-tests:\n          requires:\n            - deploy\n          context: featuretests\n          filters:\n            branches:\n              only:\n                - staging\n```\n\nWhen you work on the config file be very careful with the indentation. Before trying your config live you can run validation if you have CircleCI's cli installed, i.e. `circleci config validate`. Using the cli you can also run the build locally. For more information go to [local-cli](https://circleci.com/docs/2.0/local-cli/).\n\nComplete file `config.yml`:\n\n```yml\nversion: 2\nworkflows:\n  version: 2\n  build_test_deploy:\n    jobs:\n      - deploy:\n          context: aws\n          filters:\n            branches:\n              only:\n                - staging\n                - production\n      - feature-tests:\n          requires:\n            - deploy\n          context: featuretests\n          filters:\n            branches:\n              only:\n                - staging\njobs:\n  deploy:\n    docker:\n      - image: application-image.xxx.xxx.eu-west-1.amazonaws.com/node:latest\n    working_directory: ~/code\n    steps:\n      - checkout\n      - restore_cache: # special step to restore the dependency cache\n          key: dependency-cache-{{ checksum \"yarn.lock\" }}\n      - run:\n          name: yarn\n          command: yarn --no-progress\n      - save_cache: # special step to save the dependency cache\n          key: dependency-cache-{{ checksum \"yarn.lock\" }}\n          paths:\n            - ./node_modules\n      - run:\n          name: node-sass\n          command: npm rebuild node-sass\n      - run:\n          name: yarn test\n          command: yarn test\n      - run:\n          name: yarn build\n          command: NODE_ENV=$CIRCLE_BRANCH yarn build\n      - run:\n          name: deploy\n          command: ./deploy.sh\n  feature-tests:\n    docker:\n      - image: feat-tests-image.xxx.xxx.eu-west-1.amazonaws.com/feature-tests:latest\n    working_directory: /app\n    steps:\n      - run:\n          name: run tests\n          command: |\n            bundle exec cucumber features/application_under_test\n      # collect reports\n      - store_test_results:\n          path: /tmp\n      - store_artifacts:\n          path: /reports\n```\n"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"set-up-automation-tests-in-circleci"},"buildId":"YfngYCKqE4veWCi3zrSBC","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>